/*
 * The Spread Toolkit.
 *     
 * The contents of this file are subject to the Spread Open-Source
 * License, Version 1.0 (the ``License''); you may not use
 * this file except in compliance with the License.  You may obtain a
 * copy of the License at:
 *
 * http://www.spread.org/license/
 *
 * or in the file ``license.txt'' found in this distribution.
 *
 * Software distributed under the License is distributed on an AS IS basis, 
 * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License 
 * for the specific language governing rights and limitations under the 
 * License.
 *
 * The Creators of Spread are:
 *  Yair Amir, Michal Miskin-Amir, Jonathan Stanton, John Schultz.
 *
 *  Copyright (C) 1993-2014 Spread Concepts LLC <info@spreadconcepts.com>
 *
 *  All Rights Reserved.
 *
 * Major Contributor(s):
 * ---------------
 *    Amy Babay            babay@cs.jhu.edu - accelerated ring protocol.
 *    Ryan Caudy           rcaudy@gmail.com - contributions to process groups.
 *    Claudiu Danilov      claudiu@acm.org - scalable wide area support.
 *    Cristina Nita-Rotaru crisn@cs.purdue.edu - group communication security.
 *    Theo Schlossnagle    jesus@omniti.com - Perl, autoconf, old skiplist.
 *    Dan Schoenblum       dansch@cnds.jhu.edu - Java interface.
 *
 */



/* 
 * simple_user.c
 *
 * This simple program demonstrates how to use the Spread library.
 * 
 */

#include <sp.h>

#include <stdio.h>
#include <unistd.h>
#include <stdlib.h>
#include <string.h>
#include <time.h>

static	char	User[80];
static  char    Spread_name[80];
static  char    Private_group[MAX_GROUP_NAME];
static  mailbox Mbox;


static	int	Read_message();
static	void	Usage( int argc, char *argv[] );
int max_nodes, msg_recibidos,max_rcv,msg_recibidos_inicio;

int main( int argc, char *argv[] )
{
	int	ret,node_ID,msg_count,msg_len;
	unsigned int	mess_len;
	time_t t_inicial, t_final;
	double t_transmision,t_acumulado;
	char	mess[2000000];
	char	diccionario[]="21456097091039070194560970910390701922019230920939178784133235478456003907019220192309209391787841332354784039070192201923092093917878413323547840390701922019230920939178784133235478403907019220192309209391787841332354784039070192201923092093917878413323547840390701922019230920939178784133235478403907019220192309209391787841332354784039070192201923092093917878413323547840390701922019230920939178784133235478403907019220192309209391787841332354784039070192201923092093917878413323547840390701922019230920939178784133235478403907019220192309209391787841332354784039070192201923092093917878413323547840390701922019230920939178784133235478497091039070192201923092093917878413323547821456097091039070192201923092093917878413323547898968787878787879845213112149798214560970910390701922019230920939178784133235478989687878787878798452131121497982145609709103907019220192309209391787841332354789896878787878787984521311214979821456097091039070192201923092093917878413323547898968787878787879845213112149798214560970910390701922019230920939178784133235478989687878787878798452131121497982145609709103907019220192309209391787841332354789896878787878787984521311214979821456097091039070192201923092093917878413323547898968787878787879845213112149798214560970910390701922019230920939178784133235478989687878787878798452131121497982145609709103907019220192309209391787841332354789896878787878787984521311214979821456097091039070192201923092093917878413323547898968787878787879845213112149798214560970910390701922019230920939178784133235478989687878787878798452131121497982145609709103907019220192309209391787841332354789896878787878787984521311214979821456097091039074560970910390701922019230920939178784133235478214560970910390701922019230920939178784133235478989687878787878798452131121497982145609709103907019220192309209391787841332354789896878787878787984521311214979821456097091039070192201923092093917878413323547898968787878787879845213112149798214560970910390701922019230920939178784133235478989687878787878798452131121497982145609709103907019220192309209391787841332354789896878787878787984521311214979821456097091039070192201923092093917878413323547898968787878787879845213112149798214560970910390701922019230920939178784133235478989687878787878798452131121497982145609709103907019220192309209391787841332354789896878787878787984521311214979821456097091039070192201923092093917878413323547898968787878787879845213112149798214560970910390701922019230920939178784133235478989687878787878798452131121497982145609709103907019220192309209391787841332354789896878787878787984521311214979821456097091039070192201923092093917878413323547898968787878787879845213112149798214560970910390745609709103907019220192309209391787841332354782145609709103907019220192309209391787841332354789896878787878787984521311214979821456097091039070192201923092093917878413323547898968787878787879845213112149798214560970910390701922019230920939178784133235478989687878787878798452131121497982145609709103907019220192309209391787841332354789896878787878787984521311214979821456097091039070192201923092093917878413323547898968787878787879845213112149798214560970910390701922019230920939178784133235478989687878787878798452131121497982145609709103907019220192309209391787841332354789896878787878787984521311214979821456097091039070192201923092093917878413323547898968787878787879845213112149798214560970910390701922019230920939178784133235478989687878787878798452131121497982145609709103907019220192309209391787841332354789896878787878787984521311214979821456097091039070192201923092093917878413323547898968787878787879845213112149798214560970910390701922019230920939178784133235478989687878787878798452131121497982145609709103907214560970910390701922019230920939178784133235478989687878787878798452131121497982145609709103907019220192309209391787841332354789896878787878787984521311214979821456097091039070192201923092093917878413323547898968787878787879845213112149798214560970910390701922019230920939178784133235478989687878787878798452131121497982145609709103907019220192309209391787841332354789896878787878787984521311214979821456097091039070192201923092093917878413323547898968787878787879845213112149798214560970910390701922019230920939178784133235478989687878787878798452131121497982145609709103907019220192309209391787841332354789896878787878787984521311214979821456097091039070192201923092093917878413323547898968787878787879845213112149798214560970910390701922019230920939178784133235478989687878787878798452131121497982145609709103907019220192309209391787841332354789896878787878787984521311214979821456097091039070192201923092093917878413323547898968787878787879845213112149798214560970910390745609709103907019220192309209391787841332354782145609709103907019220192309209391787841332354789896878787878787984521311214979821456097091039070192201923092093917878413323547898968787878787879845213112149798214560970910390701922019230920939178784133235478989687878787878798452131121497982145609709103907019220192309209391787841332354789896878787878787984521311214979821456097091039070192201923092093917878413323547898968787878787879845213112149798214560970910390701922019230920939178784133235478989687878787878798452131121497982145609709103907019220192309209391787841332354789896878787878787984521311214979821456097091039070192201923092093917878413323547898968787878787879845213112149798214560970910390701922019230920939178784133235478989687878787878798452131121497982145609709103907019220192309209391787841332354789896878787878787984521311214979821456097091039070192201923092093917878413323547898968787878787879845213112149798214560970910390701922019230920939178784133235478989456097091039070192201923092093917878413323547821456097091039070192201923092093917878413323547898968787878787879845213112149798214560970910390701922019230920939178784133235478989687878787878798452131121497982145609709103907019220192309209391787841332354789896878787878787984521311214979821456097091039070192201923092093917878413323547898968787878787879845213112149798214560970910390701922019230920939178784133235478989687878787878798452131121497982145609709103907019220192309209391787841332354789896878787878787984521311214979821456097091039070192201923092093917878413323547898968787878787879845213112149798214560970910390701922019230920939178784133235478989687878787878798452131121497982145609709103907019220192309209391787841332354789896878787878787984521311214979821456097091039070192201923092093917878413323547898968787878787879845213112149798214560970910390701922019230920939178784133235478989687878787878798452131121497982145609709103907019220192309209391787841332354789896878787878787984521311214979821456097091039074560970910390701922019230920939178784133235478214560970910390701922019230920939178784133235478989687878787878798452131121497982145609709103907019220192309209391787841332354789896878787878787984521311214979821456097091039070192201923092093917878413323547898968787878787879845213112149798214560970910390701922019230920939178784133235478989687878787878798452131121497982145609709103907019220192309209391787841332354789896878787878787984521311214979821456097091039070192201923092093917878413323547898968787878787879845213112149798214560970910390701922019230920939178784133235478989687878787878798452131121497982145609709103907019220192309209391787841332354789896878787878787984521311214979821456097091039070192201923092093917878413323547898968787878787879845213112149798214560970910390701922019230920939178784133235478989687878787878798452131121497982145609709103907019220192309209391787841332354789896878787878787984521311214979821456097091039070192201923092093917878413323547898968787878787879845213112149798214560970910390768787878787879845213112149798214560970910390722019230920939178784133235478214560970910390701922019230920939178784133235478989687878787878798452131121497982145609709103907019220192309209391787841332354789896878787878787984521311214979821456097091039070192201923092093917878413323547898968787878787879845213112149798214560970910390701922019230920939178784133235478989687878787878798452131121497982145609709103907019220192309209391787841332354789896878787878787984521311214979821456097091039070192201923092093917878413323547898968787878787879845213112149798214560970910390701922019230920939178784133235478989687878787878798452131121497982145609709103907019220192309209391787841332354789896878787878787984521311214979821456097091039070192201923092093917878413323547898968787878787879845213112149798214560970910390701922019230920939178784133235478989687878787878798452131121497982145609709103907019220192309209391787841332354789896878787878787984521311214979821456097091039070192201923092093917878413323547898968787878787879845213112149798214560970910390701922019230920939178784133235478989687878787878798452131121497989896878787878787984521311214979879889795454546546572232356897879879878788787878121332221145783322211457833222114578332221145783322211457833222114578332221145783322211457833222114578332221145783322211457833222114578332221145783322211457833222114578332221145783322211457833222114578332221145783322211457833222114578332221145783322211457833222114578332221145783322211457833222114578121212121124781211455154856663322211457833222114578332221145789501";
	char cont_sinc[1000];	
	t_acumulado=0;
	
//en la variable diccionario se encuentran cargados numeros aleatorios que luego serán usados para cargar el mensaje con los n bytes solicitados

	//Validacion de la entrada
	
	if(argc!=5){
	
	printf("La cantidad de parametros ingresada es invalida %d\n",argc);
	return 0;
	}
	
	//Muestra la información ingresada
	printf("\n============================\n");
	printf("\n==========Bievenido %s==========\n\n",argv[1]);
	node_ID=atoi(argv[1]);
	max_nodes=atoi(argv[2]);
	printf("Cantidad maxima de nodos: %d\n",max_nodes);
	msg_count=atoi(argv[3]);
	printf("Cantidad maxima de mensajes a recibir: %d\n",msg_count);
	msg_len=atoi(argv[4]);
	printf("Longitud del mensaje: %d\n",msg_len);
	
	//Inicializa los contadores
	msg_recibidos_inicio=0;	
	msg_recibidos=0;
	
	printf("\n============================\n");
	

	/* connecting to the daemon, requesting group information */
	ret = SP_connect( Spread_name, User, 0, 1, &Mbox, Private_group );
	if( ret < 0 ) 
	{
		SP_error( ret );
		exit(0);
	}
	
	
	printf("\n===La etapa de envio comenzará cuando se conecten todos los miembros===\n");


	/* joining a group */
	SP_join( Mbox, "simple_group" );
	do{
	
	ret = Read_message();
	printf("\nEsperando al resto de los miembros...\n");
	msg_recibidos_inicio++;
	//printf("\nMiembros restantes %d\n",max_nodes-msg_recibidos);

	}while( msg_recibidos_inicio<max_nodes);
	//envio de mensaje de sincronización

	printf("Se envió el mensaje de sincronización\n");
			
	sprintf(cont_sinc,"%d",msg_recibidos_inicio);
			
	strncpy(mess,cont_sinc, strlen(cont_sinc));
			
	mess_len = strlen(mess);
			
	ret = SP_multicast( Mbox, AGREED_MESS, "simple_group", 1, mess_len, mess);
	ret = Read_message();
	
	msg_recibidos=0;
	printf("\n============================\n");	
	printf("\nTodos los miembros se encuentran conectados\n");
	
	if((time(&t_inicial))==-1){
				printf("\nFallo la medicion del tiempo\n");
				return 0;
			}
	for(int i=0;i<msg_count;i++)
	{
	
			//envio de mensaje MSG_LEN
			printf("\nComienza el intercambio de mensajes Nº: %d \n",i+1);
			
			
			strncpy(mess,diccionario, msg_len);
			mess_len = strlen(mess);
			
			ret = SP_multicast( Mbox, AGREED_MESS, "simple_group", 1, mess_len, mess);
			printf("Mensaje  %d  enviado\n",i+1);
			
			do{
				ret = Read_message();
				msg_recibidos++;	
			} while(msg_recibidos!=max_nodes);
			printf("\n============================\n");
			printf("\nTodos los mensajes de los miembros fueron recibidos\n",msg_recibidos-1);
			printf("\n============================\n");
			
			msg_recibidos=0;
	
	}
	if((time(&t_final))==-1){
				printf("\nFallo la medicion del tiempo\n");
				return 0;
			}
	t_acumulado=difftime(t_final,t_inicial);

	printf("\n==============Resultados============\n");
	printf("\nEl tiempo acumulado es: %.2lf seg \n",t_acumulado);
	printf("\nEl total de bytes transmitidos fue: %ld bytes \n",msg_count*msg_len);
	printf("\nEl throughput del sistema es: %lf [bytes/seg]\n",(msg_count*msg_len)/t_acumulado);
	printf("\n==============FIN============\n");

	return 0;
	
	
}


static	int	Read_message()
{

static	char		mess[102400];
	char		sender[MAX_GROUP_NAME];
	char		target_groups[100][MAX_GROUP_NAME];
	int		num_groups;
        membership_info memb_info;
	int		service_type;
	int16		mess_type;
	int		endian_mismatch;
	int		i;
	int		ret;

	
        service_type = 0;
	ret = SP_receive( Mbox, &service_type, sender, 100, &num_groups, target_groups, 
		&mess_type, &endian_mismatch, sizeof(mess), mess );
	printf("Mensaje recibido de %s\n", sender);
	if( ret < 0 ) 
	{
		SP_error( ret );
		exit(0);
	}

	if( Is_regular_mess( service_type ) )
	{
		/* A regular message, sent by one of the processes */
		mess[ret] = 0;
		
		//No imprime los mensajes enviados por él mismo
		printf("%s envio el mensaje\n", sender);
		printf("%s recibió el mensaje\n", User);
		if ( !strcmp(User,sender)){
			if     ( Is_unreliable_mess( service_type ) ) printf("received UNRELIABLE \n");
			else if( Is_reliable_mess(   service_type ) ) printf("received RELIABLE \n");
			else if( Is_fifo_mess(       service_type ) ) printf("received FIFO \n");
			else if( Is_causal_mess(     service_type ) ) printf("received CAUSAL \n");
			else if( Is_agreed_mess(     service_type ) ) printf("received AGREED \n");
			else if( Is_safe_mess(       service_type ) ) printf("received SAFE \n");
			printf("mensaje de %s del tipo %d (endian %d), para %d grupos \n(%d bytes): %s\n",
				sender, mess_type, endian_mismatch, num_groups, ret, mess );
		}
			
			if(atoi(mess)==max_nodes){
				msg_recibidos_inicio=atoi(mess);
				//printf("El mensaje recibido anteriormente fué de sincronización\n");
			}
		

	}else if( Is_membership_mess( service_type ) ){
		/* A membership notification */
                ret = SP_get_memb_info( mess, service_type, &memb_info );
                if (ret < 0) {
                        printf("BUG: membership message does not have valid body\n");
                        SP_error( ret );
                        exit( 1 );
                }
		if     ( Is_reg_memb_mess( service_type ) )
		{
			printf("received REGULAR membership \n");
			if( Is_caused_join_mess( service_type ) ) printf("Se ha UNIDO \n");
			if( Is_caused_leave_mess( service_type ) ) printf("Nos ha DEJADO \n");
			if( Is_caused_disconnect_mess( service_type ) ) printf("Se ha DESCONECTADO \n");
			printf("al grupo %s con %d miembros:\n",
				sender, num_groups );
			for( i=0; i < num_groups; i++ )
				printf("\t%s\n", &target_groups[i][0] );
			printf("grp id is %d %d %d\n",memb_info.gid.id[0], memb_info.gid.id[1], memb_info.gid.id[2] );
		}else if( Is_transition_mess(   service_type ) ) {
			printf("received TRANSITIONAL membership for group %s\n", sender );
		}else if( Is_caused_leave_mess( service_type ) ){
			printf("received membership message that left group %s\n", sender );
		}else printf("received incorrect membership message of type %d\n", service_type );
	}else printf("received message of unknown message type %d with %d bytes\n", service_type, ret);
	return( service_type );
}

